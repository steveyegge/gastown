# Migration to Gas Town 0.2.0

This guide covers migrating from Gas Town 0.1.x to 0.2.0.

## What Changed

### Directory Structure

| Component | 0.1.x | 0.2.x |
|-----------|-------|-------|
| Config location | `town.json` at root | `mayor/town.json` |
| Rigs registry | `rigs.json` at root | `mayor/rigs.json` |
| Rig settings | Mixed locations | `<rig>/settings/` |
| Runtime state | Various | `<rig>/.runtime/` (gitignored) |

### Beads Architecture

- **0.1.x**: Single-level beads database at town root with `gt-*` prefix
- **0.2.x**: Updated prefix naming:
  - Town-level beads remain at `<town>/.beads/`
  - Agent prefixes change from `gt-*` to `hq-*` (e.g., `hq-mayor`, `hq-deacon`)

### Agent Naming

| 0.1.x | 0.2.x |
|-------|-------|
| `gt-mayor` | `hq-mayor` |
| `gt-deacon` | `hq-deacon` |

## Before You Begin

1. **Backup your workspace** - While the migration creates backups automatically, having an extra copy is always safe.

2. **Stop running agents** - Ensure no agents are actively running:
   ```bash
   gt seance              # List recent sessions
   gt seance --recent 20  # Check last 20 sessions for active ones
   ```

3. **Commit any pending changes** - The migration modifies workspace structure.

## Running the Migration

### Step 1: Check Migration Status

```bash
gt migrate --check
```

This shows:
- Current workspace version
- Target version
- Migration path

You can also view detailed status information:

```bash
gt migrate --status
```

This shows current migration state, backup count, and layout details.

### Step 2: Preview Changes

```bash
gt migrate --dry-run    # or: gt migrate -n
```

This shows what will be changed without making any modifications.

### Step 3: Execute Migration

**Interactive mode** (prompts for confirmation):
```bash
gt migrate
```

**Explicit execution**:
```bash
gt migrate --execute
```

**Auto-confirmation** (no prompts):
```bash
gt migrate --force      # or: gt migrate -f
```

The migration:
1. Creates backup in `.migration-backup/<timestamp>/`
2. Creates `mayor/` directory if needed
3. Moves `town.json`, `rigs.json`, `accounts.json` (if present) to `mayor/`
4. Creates `settings/` directories in each rig
5. Creates `.runtime/` directories for gitignored state
6. Adds `.runtime/` to `.gitignore` if not already present
7. Migrates agent beads from `gt-*` to `hq-*` prefix
8. Cleans up empty legacy directories
9. Updates workspace version
10. Runs post-migration verification

### Step 4: Verify

```bash
gt doctor
```

This confirms the workspace is healthy after migration.

## Rollback

If something goes wrong, restore from the backup:

```bash
gt migrate --rollback
```

This prompts for confirmation, then restores files from the most recent backup.

To skip confirmation:
```bash
gt migrate --rollback --force
```

Manual restoration:
```bash
# Find the backup directory
ls .migration-backup/

# Restore specific files
cp .migration-backup/<timestamp>/town.json .
cp .migration-backup/<timestamp>/rigs.json .
```

### What Gets Backed Up

The migration backs up the following files (if they exist):
- `town.json` - Legacy root-level config
- `rigs.json` - Legacy root-level rigs registry
- `mayor/town.json` - New location config
- `mayor/rigs.json` - New location rigs registry
- `mayor/accounts.json` - Accounts configuration
- `.beads/config.json` - Beads configuration
- `.beads/routes.jsonl` - Beads routing database
- `.beads/next_sequence.json` - Beads sequence counter

## Migration Steps Detail

### 1. Create Mayor Directory

Creates `mayor/` if it doesn't exist. This is the new home for town-level configuration.

### 2. Move Config Files

Moves configuration files from root to `mayor/`:
- `town.json` → `mayor/town.json`
- `rigs.json` → `mayor/rigs.json`
- `accounts.json` → `mayor/accounts.json` (only if present)

### 3. Create Rig Settings

Creates `settings/` directory in each rig for git-tracked configuration:
```
<rig>/
└── settings/
```

### 4. Create Runtime Directories

Creates `.runtime/` directories for non-tracked runtime state:
```
<town>/
├── .runtime/           # Town-level runtime
└── <rig>/
    └── .runtime/       # Rig-level runtime
```

This step also modifies `.gitignore` to add `.runtime/` if not already present, ensuring runtime state is never committed.

### 5. Migrate Agent Beads

Updates beads routing to use new prefixes:
- `gt-mayor` → `hq-mayor`
- `gt-deacon` → `hq-deacon`

### 6. Cleanup Legacy

Removes empty `.gastown/` directories that are no longer used.

## Troubleshooting

### Migration fails with "town.json not found"

Ensure you're running from within a Gas Town workspace:
```bash
gt doctor
```

### Beads database errors after migration

Re-sync the beads database using the beads CLI (`bd`):
```bash
bd sync
```

If `bd` is not in your PATH, you can run it from the Gas Town bin directory or reinstall Gas Town to get the `bd` command.

### Agent sessions not connecting

The agent bead prefixes changed. Restart the Mayor and Deacon:
```bash
gt mayor restart
gt deacon restart
```

### Custom scripts reference old paths

Update any scripts that reference:
- `town.json` → `mayor/town.json`
- `rigs.json` → `mayor/rigs.json`

## Need Help?

- Run `gt doctor` to check workspace health
- Check the [Gas Town issues](https://github.com/steveyegge/gastown/issues) for known problems
- Create a new issue with `gt migrate --status` output
