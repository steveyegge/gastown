# Documentation Review: Convoy Stage & Launch

**Date:** 2026-02-20T07:25:18
**Reviewer:** Multi-LLM (Opus 4.6 + GPT 5.3 Codex)

## Review Configuration

- **LLMs Used:** Opus 4.6 + GPT 5.3 Codex
- **Documents Reviewed:** `docs/design/convoy/stage-launch/prd.md`, `docs/design/convoy/stage-launch/testing.md`
- **Codebase:** `/home/krystian/gt/gastown/crew/l0g1x/` (verified against actual source)
- **Categories Checked:** Codebase Match, Cross-Document Consistency, API & Interface Assumptions, Security, Design Quality, TDD Alignment, Project Standards
- **Categories Skipped:** Architectural Consistency, Error Handling, Performance, Data/Schema, Task Dependencies

---

## Synthesized Issues (Risk-Weighted)

### CRITICAL

**1. Staged status format unresolved + codebase rejects non-open/closed**

The entire PRD/testing plan assumes `staged_ready`/`staged_warnings` statuses, but:
- `ensureKnownConvoyStatus` (`convoy.go:96-108`) only accepts `"open"` and `"closed"` — any staged status returns an error
- `validateConvoyStatusTransition` (`convoy.go:110-131`) has no staged transitions
- `bd doctor` regex `^[a-z][a-z0-9_]*$` rejects colons
- 14+ callsites use `ensureKnownConvoyStatus` (add, close, land, check)

PRD correctly flags this as blocking (Q1), but the gap between "blocking open question" and "used as hard dependency throughout both docs" needs resolution before implementation.

**2. Daemon feeding has no staged-convoy guard — dual-path problem**

The PRD says "daemon MUST NOT feed staged convoys" (I-7), but the actual codebase has two distinct feeding paths that need separate guards:
- **Event-driven path** (`operations.go:57,70`): `isConvoyClosed` checks only `status == "closed"`. A `staged_ready` convoy passes this check and gets fed.
- **Stranded scan path** (`convoy.go:1231`): uses `bd list --status=open` which excludes non-open statuses — this path is safe by accident.

The PRD's "Key files expected to be modified" section mentions updating both files but doesn't call out the dual-path problem or the asymmetric behavior.

### HIGH

**3. FR-7 launch dispatch needs `--no-convoy` flag**

FR-7 says "use existing `gt sling` for dispatch (one task at a time)." But each `gt sling` call creates its own auto-convoy via `createAutoConvoy`. For launch, the staged convoy already exists — launching would create N duplicate convoys for N Wave 1 tasks. Launch must pass `--no-convoy` (or equivalent) to prevent this. PRD doesn't mention this.

**4. DS-07/DS-08 don't specify which feeding path they test**

These tests cover "daemon skips staged_ready/staged_warnings convoy" but don't distinguish between event-driven and stranded scan paths. Given finding #2 (one path is safe, the other isn't), the testing plan needs separate test coverage for each path.

**5. FR-10 (mixed input rejection) is P2 but should be P0/P1**

FR-10 was added as a functional requirement ("MUST reject mixed input types"), but IT-35 (the covering test) is P2. A functional requirement that "MUST" reject mixed input types should ship with the feature.

### MEDIUM

**6. Batch sling characterization inaccurate in Problem #3**

PRD says "spawns a polecat for every task immediately" and tasks "sit idle." Both agents found the actual code iterates sequentially with throttling (`sling_batch.go:122-312`). The real issue is dispatch without dependency-aware ordering, not "everything at once."

**7. `createBatchConvoy` reuse reference: rigName incompatible + missing file path**

PRD lists `createBatchConvoy` pattern as reusable, but: (a) it requires a `rigName` parameter — stage/launch convoys may span multiple rigs, and (b) the file path (`sling_convoy.go:309`) isn't cited. The *pattern* (create + tracks deps) is reusable; the function isn't.

**8. `molecule_dag.go` `computeTiers` silently breaks on cycles**

The existing Kahn's algorithm at `molecule_dag.go:234-237` silently `break`s when it detects a cycle instead of returning an error with the cycle path. New `detectCycles` must be separate and return the path (per US-002 AC-1). PRD should note this isn't reusable for cycle detection despite being prior art.

**9. IT-09/IT-43 orphan definition tension with US-004 Wave 1**

US-003 AC-1 says tasks with "no blocks deps (isolated in wave graph)" are orphans (warning). US-004 AC-3 says tasks "not reachable by any blocking dep chain" go into Wave 1 (normal). A task can be both "Wave 1" and "orphan" — the distinction depends on input type (epic vs task-list). IT-43 should clarify this is only a warning for epic input.

**10. FR-2 doesn't specify CLI vs Go SDK for tree walking**

Existing code in `molecule_dag.go:86-93` uses `beads.List(ListOptions{Parent: rootID})` (Go SDK), but FR-2 specifies `bd dep list --type=parent-child --direction=down` (CLI). Both work but have different tradeoffs (subprocess overhead vs SDK speed, stub-ability vs directness).

**11. IT-33 (skip re-analysis for staged_ready launch) should be P0**

This is a core semantic of the stage-then-launch workflow. If launch re-analyzes unnecessarily, the status could flip to `staged_warnings`, breaking user expectations. Currently P1.

### LOW

**12. F-15 cross-reference maps to IT-06 which tests a different scenario**

F-15 is "routes.jsonl missing or corrupt" but IT-06 is "no valid rig" (unresolvable prefix). These overlap but aren't the same.

**13. Sleep anti-pattern guidance targets wrong scenario**

The warning about `time.Sleep` should target daemon integration tests (DS-09), not launch dispatch tests.

**14. `CLAUDE.md` not in workspace — project standards partially unverified**

`AGENTS.md` exists but defers to `CLAUDE.md` which isn't present in the repo (injected at session start by `gt prime`). Standards check is limited.

---

## Agent Comparison

| # | Issue | Opus | GPT | Agree? | Recommendation |
|---|-------|------|-----|--------|----------------|
| 1 | Staged status unresolved | CRITICAL — detailed analysis of `ensureKnownConvoyStatus`, `validateConvoyStatusTransition`, all callsites | CRITICAL — cites same evidence, shorter | **Yes** | Resolve Q1 before implementation |
| 2 | Daemon dual-path guard | CRITICAL — identified event-driven vs stranded scan asymmetry, quoted `isConvoyClosed` | HIGH — noted broadly, less specific about dual paths | **Partial** | Opus more precise; both agree guard is needed |
| 3 | FR-7 needs --no-convoy | HIGH — identified auto-convoy creation per `gt sling` call | Not found | N/A | Opus correct; PRD must address this |
| 4 | DS-07/DS-08 path coverage | HIGH — split needed for dual paths | Not found | N/A | Follow from finding #2 |
| 5 | FR-10 test priority | Not found | HIGH — FR-10 is P2, should be P0/P1 | N/A | GPT correct; promote IT-35 |
| 6 | Batch sling characterization | HIGH — "sit idle" is misleading | MEDIUM — "everything at once" is wrong | **Yes** | Different angles, both valid |
| 7 | createBatchConvoy reuse | MEDIUM — rigName incompatible | MEDIUM — missing file path | **Partial** | Complementary; both issues real |
| 8 | computeTiers cycle handling | MEDIUM — silently breaks | Not found | N/A | Opus correct; note in PRD |
| 9 | Orphan definition tension | MEDIUM — Wave 1 vs orphan conflict | Not found | N/A | Opus correct; clarify in PRD |
| 10 | FR-2 CLI vs SDK | MEDIUM — existing code uses SDK | Not found | N/A | Worth noting for implementation |
| 11 | IT-33 priority | MEDIUM — should be P0 | Not found | N/A | Agree; promote |

**Agreement rate:** 4 of 11 unique issues found by both agents (36%). Opus found 10, GPT found 6 (4 shared + 2 unique).

---

## Reasoning

### Finding 1: Staged status format (CRITICAL)

Both agents independently identified this as the top issue. The PRD already marks Q1 as "architecturally blocking" but then proceeds to use `staged_ready`/`staged_warnings` as hard dependencies in FR-6, I-7, I-8, DS-07, DS-08, and dozens of test descriptions. The codebase evidence is definitive: `ensureKnownConvoyStatus` at `convoy.go:96-108` switches on `convoyStatusOpen`/`convoyStatusClosed` only — everything else returns an error. This function is called from `runConvoyAdd`, `runConvoyClose`, `runConvoyLand`, `checkSingleConvoy`, `isSlingableBead`, and more (14+ callsites). No implementation can proceed without resolving the format.

### Finding 2: Daemon dual-path guard (CRITICAL)

Opus provided the stronger analysis here, identifying the specific asymmetry: stranded scan is safe (queries `--status=open` which excludes staged) but event-driven feeding (`CheckConvoysForIssue` → `isConvoyClosed`) only checks for `"closed"` — anything else gets fed. GPT noted the same problem at a higher level ("event-driven feeding can dispatch any non-closed convoy"). Both are correct; the PRD needs to explicitly describe the dual-path fix.

### Finding 3: FR-7 --no-convoy (HIGH)

Opus found that `gt sling` unconditionally creates a convoy via `createAutoConvoy`. If launch calls `gt sling task1 rig`, `gt sling task2 rig`, etc., each creates a separate auto-convoy — the exact N-convoy-per-bead bug the safety PR fixed for batch sling. This is a real gap in the PRD: launch must either use `--no-convoy` or call internal dispatch functions directly.

### Finding 5: FR-10 priority (HIGH)

GPT correctly identified the inconsistency: we added FR-10 as a MUST requirement, but the covering test (IT-35) is P2. Functional requirements should be tested at P0 or P1.

### Finding 6: Batch sling characterization (MEDIUM)

Both agents found the PRD's Problem #3 description doesn't match code. The word "immediately" implies parallel concurrent dispatch; the actual code iterates sequentially. The substantive issue (no dep checking) is real, but the characterization should be precise.

### Finding 9: Orphan tension (MEDIUM)

This is a genuine design tension discovered by Opus. A task with zero blocking deps is simultaneously "Wave 1" (US-004 AC-3: maximum parallelism) and potentially an "orphan" (US-003 AC-1: isolated in wave graph). The resolution is context-dependent: in epic input, an isolated task not in the descendant tree is an orphan warning. In task-list input, all tasks are explicitly selected — isolation is expected, not a warning.

---

## Remaining Ambiguities

1. **Q1 (staged status format)** — Must be resolved before implementation. The docs, tests, and codebase all depend on this.
2. **CLI vs SDK for tree walking** — Implementation decision, not a doc bug. Can defer to implementation time.
3. **`CLAUDE.md` location** — Injected by `gt prime` at session start, not a file in the repo. Standards check is limited to `AGENTS.md`.

---

## Summary

- **Total Issues:** 14 (2 critical, 3 high, 6 medium, 3 low)
- **Agent Agreement Rate:** 36% (4/11 unique issues found by both)
- **Root cause:** 5 of the 14 findings trace back to Q1 (staged status) being unresolved
- **Next Steps:** Resolve Q1, then address findings #2-#5 in PRD/testing plan before implementation begins
