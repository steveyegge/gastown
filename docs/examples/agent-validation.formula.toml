description = """
Self-test formula run by a polecat to validate its own Gas Town integration.

When slung to a rig, the polecat verifies that it received correct Gas Town
context injection, has work on its hook, can use Gas Town CLI tools, and can
execute a test task.

## Usage

```bash
gt sling agent-validation sfgastown
gt sling agent-validation pi_agent
```

## What it does

1. **Context**: Verifies Gas Town identity, role, and startup context are present
2. **Hook**: Confirms work is hooked and the bead is accessible
3. **Tools**: Validates gt and bd CLI tools are functional
4. **Task**: Executes an optional test task to prove agent responsiveness
5. **Report**: Prints pass/fail summary and completes the bead
"""
formula = "agent-validation"
type = "workflow"
version = 2

[vars.task]
description = "Optional test task to execute after validation checks"
required = false
default = "Read the first 5 lines of any source file in this repo and report them."

[[steps]]
id = "verify-context"
title = "Verify Gas Town context was injected"
description = """
Check that Gas Town context is present in your session. You should have received
identity and role information during startup.

**1. Check environment variables:**
```bash
echo "GT_ROLE=$GT_ROLE"
echo "GT_RIG=$GT_RIG"
echo "GT_POLECAT=$GT_POLECAT"
echo "GT_ROOT=$GT_ROOT"
```

At minimum, GT_ROLE should be set (typically "polecat").

**2. Verify you know your identity:**
Report the following from your injected context:
- Your role (polecat, crew, etc.)
- The rig you're working in
- The town name (Gas Town)

**3. Check that gt prime output was captured:**
```bash
gt prime 2>/dev/null | head -5
```

Record pass/fail for each check.

**Exit criteria:** Gas Town context is confirmed present in your session."""

[[steps]]
id = "verify-hook"
title = "Verify work is on your hook"
needs = ["verify-context"]
description = """
Confirm that this validation bead is hooked to you.

**1. Check your hook:**
```bash
gt hook
```

The output should show a hooked bead (the validation bead that triggered this formula).

**2. Verify the bead is accessible:**
```bash
bd show $(gt hook --id 2>/dev/null || echo "unknown")
```

If `gt hook --id` isn't available, check `gt hook` output for the bead ID and use that.

**3. Verify bead status:**
The hooked bead should be in_progress.

**Exit criteria:** Hook shows assigned work, bead is accessible via bd."""

[[steps]]
id = "verify-tools"
title = "Verify Gas Town CLI tools work"
needs = ["verify-hook"]
description = """
Run basic Gas Town commands to verify the CLI is functional.

**1. Check gt is available:**
```bash
gt --version
```

**2. Check bd is available:**
```bash
bd --version
```

**3. Check rig status:**
```bash
gt rig list
```

**4. Check beads access:**
```bash
bd stats
```

**5. Check mail access:**
```bash
gt mail inbox 2>/dev/null || echo "Mail check: skipped or unavailable"
```

Record pass/fail for each tool check.

**Exit criteria:** Core CLI tools (gt, bd) are functional."""

[[steps]]
id = "execute-task"
title = "Execute a test task"
needs = ["verify-tools"]
description = """
Execute the test task to prove agent responsiveness.

**Task:** {{task}}

Execute the task above and record the output. This proves the agent can
receive instructions and produce results within the Gas Town framework.

**Exit criteria:** Test task executed, output captured."""

[[steps]]
id = "report-and-complete"
title = "Report results and complete"
needs = ["execute-task"]
description = """
Print a summary of all validation checks and complete the bead.

**1. Print summary:**
```
=== Agent Validation Self-Test ===

Gas Town context:     [PASS/FAIL]
  - Role awareness:   [PASS/FAIL]
  - Rig identity:     [PASS/FAIL]
  - Startup context:  [PASS/FAIL]
Hook assignment:      [PASS/FAIL]
  - Work hooked:      [PASS/FAIL]
  - Bead accessible:  [PASS/FAIL]
CLI tools:            [PASS/FAIL]
  - gt available:     [PASS/FAIL]
  - bd available:     [PASS/FAIL]
  - Rig list:         [PASS/FAIL]
Test task execution:  [PASS/FAIL]

VALIDATION_OK
```

Include VALIDATION_OK in the output if all critical checks pass.

**2. Add results to bead notes:**
```bash
bd update <bead-id> --notes "Validation complete. All checks passed."
```

**3. Complete the bead:**
The bead will be closed when you finish (via gt done or bd close).

**Exit criteria:** Results summarized, bead completed."""
