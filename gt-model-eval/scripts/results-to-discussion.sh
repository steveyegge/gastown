#!/usr/bin/env bash
# Format promptfoo eval results as markdown and optionally post to GitHub Discussions.
#
# Usage:
#   ./scripts/results-to-discussion.sh results.json                # dry-run (stdout)
#   ./scripts/results-to-discussion.sh results.json --post         # post to Discussions
#   ./scripts/results-to-discussion.sh results.json --post --repo owner/repo
#
# Requires: jq, gh (if --post)

set -euo pipefail

RESULTS_FILE="${1:?Usage: $0 results.json [--post] [--repo owner/repo]}"
POST=false
REPO="steveyegge/gastown"
CATEGORY="Ideas"

shift || true
while [[ $# -gt 0 ]]; do
  case "$1" in
    --post) POST=true; shift ;;
    --repo) REPO="$2"; shift 2 ;;
    --category) CATEGORY="$2"; shift 2 ;;
    *) echo "Unknown flag: $1" >&2; exit 1 ;;
  esac
done

if ! command -v jq &>/dev/null; then
  echo "Error: jq is required" >&2
  exit 1
fi

if ! [ -f "$RESULTS_FILE" ]; then
  echo "Error: $RESULTS_FILE not found" >&2
  exit 1
fi

# --- Extract data ---

# Get provider labels
PROVIDERS=$(jq -r '.results.table.head.prompts[].provider' "$RESULTS_FILE" 2>/dev/null \
  || jq -r '.results.providers[]' "$RESULTS_FILE" 2>/dev/null \
  || echo "unknown")

# Count results per provider
TOTAL=$(jq '.results.table.body | length' "$RESULTS_FILE" 2>/dev/null || echo "0")

# Build summary by parsing the results structure
generate_summary() {
  local file="$1"

  # Try to extract pass/fail counts per provider from the results
  # promptfoo JSON structure: results.results[] has .provider and .success
  jq -r '
    # Group results by provider
    [.results.results[] | {provider: .provider.label, success: .success, cost: (.cost // 0), latency: (.latencyMs // 0)}]
    | group_by(.provider)
    | map({
        provider: .[0].provider,
        total: length,
        passed: [.[] | select(.success == true)] | length,
        failed: [.[] | select(.success == false)] | length,
        avg_cost: ([.[].cost] | add / length * 1000 | round / 1000),
        avg_latency: ([.[].latency] | add / length | round)
      })
    | sort_by(.provider)
    | .[] | "\(.provider)|\(.passed)/\(.total)|\(.passed * 100 / .total | round)%|$\(.avg_cost)|\(.avg_latency)ms"
  ' "$file" 2>/dev/null || echo "Could not parse results. Check JSON structure."
}

# --- Generate markdown ---

DATE=$(date -u +%Y-%m-%d)
USER=$(whoami)

MARKDOWN="$(cat <<HEADER
## Model Comparison Results: ${DATE}

**Reporter**: ${USER}
**Framework**: [gt-model-eval](https://github.com/${REPO})
**Related**: [Discussion #1542](https://github.com/${REPO}/discussions/1542) | [Issue #1545](https://github.com/${REPO}/issues/1545)

### Summary

| Model | Tests Passed | Pass Rate | Avg Cost/Test | Avg Latency |
|-------|-------------|-----------|---------------|-------------|
HEADER
)"

# Append summary rows
SUMMARY=$(generate_summary "$RESULTS_FILE")
if [ -n "$SUMMARY" ] && [ "$SUMMARY" != "Could not parse results. Check JSON structure." ]; then
  while IFS='|' read -r provider passed rate cost latency; do
    MARKDOWN="${MARKDOWN}
| ${provider} | ${passed} | ${rate} | ${cost} | ${latency} |"
  done <<< "$SUMMARY"
else
  MARKDOWN="${MARKDOWN}
| (parse results.json manually â€” structure varies by promptfoo version) | | | | |"
fi

MARKDOWN="${MARKDOWN}

### Per-Role Breakdown

Run \`npx promptfoo@latest view\` locally to see detailed per-test results, or check the attached JSON.

### How to Reproduce

\`\`\`bash
git clone https://github.com/${REPO}.git
cd gt-model-eval
export ANTHROPIC_API_KEY=sk-...
npx promptfoo@latest eval --repeat 3
npx promptfoo@latest view
\`\`\`

### How to Share Your Results

\`\`\`bash
npx promptfoo@latest eval --output results.json
./scripts/results-to-discussion.sh results.json --post
\`\`\`

---
*Generated by gt-model-eval results pipeline*"

# --- Output or post ---

if [ "$POST" = true ]; then
  if ! command -v gh &>/dev/null; then
    echo "Error: gh CLI required for --post" >&2
    exit 1
  fi

  # Get category ID via GraphQL
  CATEGORY_ID=$(gh api graphql -f query='
    query($owner: String!, $repo: String!) {
      repository(owner: $owner, name: $repo) {
        discussionCategories(first: 20) {
          nodes { id name }
        }
      }
    }
  ' -f owner="${REPO%%/*}" -f repo="${REPO##*/}" \
    --jq ".data.repository.discussionCategories.nodes[] | select(.name == \"${CATEGORY}\") | .id" 2>/dev/null)

  if [ -z "$CATEGORY_ID" ]; then
    echo "Error: could not find Discussion category '${CATEGORY}'" >&2
    exit 1
  fi

  REPO_ID=$(gh api graphql -f query='
    query($owner: String!, $repo: String!) {
      repository(owner: $owner, name: $repo) { id }
    }
  ' -f owner="${REPO%%/*}" -f repo="${REPO##*/}" \
    --jq '.data.repository.id')

  TITLE="Model Comparison Results: ${DATE} (${USER})"

  RESULT=$(gh api graphql -f query='
    mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
      createDiscussion(input: {repositoryId: $repoId, categoryId: $categoryId, title: $title, body: $body}) {
        discussion { url }
      }
    }
  ' -f repoId="$REPO_ID" -f categoryId="$CATEGORY_ID" -f title="$TITLE" -f body="$MARKDOWN")

  URL=$(echo "$RESULT" | jq -r '.data.createDiscussion.discussion.url')
  echo "Posted to: $URL"
else
  echo "$MARKDOWN"
fi
