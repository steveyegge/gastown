#!/bin/bash
# SPDX-License-Identifier: MIT
# gt-usage - Gastown Usage Report Command
#
# Displays token usage and cost statistics for Gastown agents.
#
# Requires: jq

set -euo pipefail

VERSION="1.0.0"

show_help() {
    cat << 'EOF'
Usage: gt-usage [command] [args]

Display token usage and cost statistics for Gastown agents.

Commands:
  today              Today's summary (default)
  week               Last 7 days
  all                All recorded usage
  convoy <id>        Usage for a specific convoy
  rig <name>         Usage for a specific rig
  task <id>          Usage for a specific task
  raw                Raw JSONL output
  summary            One-line summary for task completion
  --version, -V      Show version information
  --help, -h         Show this help message

Examples:
  gt-usage                    # Today's usage by agent
  gt-usage week               # Last 7 days summary
  gt-usage convoy hq-123      # All usage in convoy hq-123
  gt-usage rig fractasy       # All usage for fractasy rig
  gt-usage summary            # One-line summary for prompts
EOF
}

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
GASTOWN_DIR="${SCRIPT_DIR}/.."

# Source the usage tracker library for functions
source "$GASTOWN_DIR/agents/lib/usage-tracker.sh"

USAGE_DIR="${GT_USAGE_DIR:-$HOME/.gastown/usage}"
USAGE_LOG="$USAGE_DIR/usage.jsonl"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Format number with commas
format_number() {
    echo "$1" | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta'
}

# Show summary header
show_header() {
    local title="$1"
    echo ""
    echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${CYAN}  $title${NC}"
    echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
}

# Show today's summary
show_today() {
    show_header "Gastown Usage Report - Today ($(date +%Y-%m-%d))"

    if [[ ! -f "$USAGE_LOG" ]]; then
        echo "No usage data recorded yet."
        echo "Usage is tracked automatically when using Gastown agents."
        return
    fi

    local today=$(date +%Y-%m-%d)
    local data=$(grep "\"date\":\"$today\"" "$USAGE_LOG" 2>/dev/null || true)

    if [[ -z "$data" ]]; then
        echo "No usage recorded today."
        return
    fi

    # By Agent
    echo -e "${BOLD}By Agent:${NC}"
    echo "$data" | jq -s '
        group_by(.agent) |
        map({
            agent: .[0].agent,
            requests: length,
            input: (map(.input_tokens) | add),
            output: (map(.output_tokens) | add),
            cost: (map(.cost_usd) | add | . * 100 | round / 100)
        }) |
        sort_by(.cost) |
        reverse |
        .[] |
        "  \(.agent): \(.requests) requests, \(.input)+\(.output) tokens, $\(.cost)"
    ' -r 2>/dev/null || echo "  Error parsing data"

    echo ""

    # Totals
    echo -e "${BOLD}Totals:${NC}"
    echo "$data" | jq -s '{
        requests: length,
        input_tokens: (map(.input_tokens) | add),
        output_tokens: (map(.output_tokens) | add),
        total_cost: (map(.cost_usd) | add | . * 100 | round / 100),
        total_duration: (map(.duration_sec) | add)
    } | "  Requests: \(.requests)\n  Input tokens: \(.input_tokens)\n  Output tokens: \(.output_tokens)\n  Total cost: $\(.total_cost)\n  Total duration: \(.total_duration)s"' -r 2>/dev/null || echo "  Error calculating totals"
}

# Show convoy usage
show_convoy() {
    local convoy_id="$1"
    show_header "Convoy Usage: $convoy_id"

    if [[ ! -f "$USAGE_LOG" ]]; then
        echo "No usage data found."
        return
    fi

    local data=$(grep "\"convoy\":\"$convoy_id\"" "$USAGE_LOG" 2>/dev/null || true)

    if [[ -z "$data" ]]; then
        echo "No usage found for convoy '$convoy_id'."
        return
    fi

    echo -e "${BOLD}By Agent:${NC}"
    echo "$data" | jq -s '
        group_by(.agent) |
        map({
            agent: .[0].agent,
            tasks: length,
            tokens: (map(.total_tokens) | add),
            cost: (map(.cost_usd) | add | . * 100 | round / 100)
        }) |
        .[] |
        "  \(.agent): \(.tasks) tasks, \(.tokens) tokens, $\(.cost)"
    ' -r 2>/dev/null

    echo ""
    echo -e "${BOLD}Summary:${NC}"
    echo "$data" | jq -s '{
        total_tasks: length,
        total_tokens: (map(.total_tokens) | add),
        total_cost: (map(.cost_usd) | add | . * 100 | round / 100),
        duration: (map(.duration_sec) | add)
    } | "  Tasks: \(.total_tasks)\n  Total tokens: \(.total_tokens)\n  Total cost: $\(.total_cost)\n  Duration: \(.duration)s"' -r 2>/dev/null
}

# Show rig usage
show_rig() {
    local rig_name="$1"
    show_header "Rig Usage: $rig_name"

    if [[ ! -f "$USAGE_LOG" ]]; then
        echo "No usage data found."
        return
    fi

    local data=$(grep "\"rig\":\"$rig_name\"" "$USAGE_LOG" 2>/dev/null || true)

    if [[ -z "$data" ]]; then
        echo "No usage found for rig '$rig_name'."
        return
    fi

    echo -e "${BOLD}By Agent:${NC}"
    echo "$data" | jq -s '
        group_by(.agent) |
        map({
            agent: .[0].agent,
            tasks: length,
            tokens: (map(.total_tokens) | add),
            cost: (map(.cost_usd) | add | . * 100 | round / 100)
        }) |
        .[] |
        "  \(.agent): \(.tasks) tasks, \(.tokens) tokens, $\(.cost)"
    ' -r 2>/dev/null

    echo ""
    echo -e "${BOLD}By Date:${NC}"
    echo "$data" | jq -s '
        group_by(.date) |
        map({
            date: .[0].date,
            requests: length,
            cost: (map(.cost_usd) | add | . * 100 | round / 100)
        }) |
        sort_by(.date) |
        reverse |
        .[0:7] |
        .[] |
        "  \(.date): \(.requests) requests, $\(.cost)"
    ' -r 2>/dev/null
}

# Show task usage
show_task() {
    local task_id="$1"

    if [[ ! -f "$USAGE_LOG" ]]; then
        echo "No usage data found."
        return
    fi

    local data=$(grep "\"task\":\"$task_id\"" "$USAGE_LOG" | tail -1)

    if [[ -z "$data" ]]; then
        echo "No usage found for task '$task_id'."
        return
    fi

    echo "$data" | jq '{
        task: .task,
        agent: .agent,
        rig: .rig,
        convoy: .convoy,
        input_tokens: .input_tokens,
        output_tokens: .output_tokens,
        cost_usd: .cost_usd,
        duration_sec: .duration_sec,
        status: .status,
        timestamp: .timestamp
    }' 2>/dev/null
}

# One-line summary for task completion messages
show_summary() {
    if [[ ! -f "$USAGE_LOG" ]]; then
        echo "No usage data"
        return
    fi

    local today=$(date +%Y-%m-%d)
    local data=$(grep "\"date\":\"$today\"" "$USAGE_LOG" 2>/dev/null || true)

    if [[ -z "$data" ]]; then
        echo "No usage today"
        return
    fi

    echo "$data" | jq -s '
        {
            requests: length,
            tokens: (map(.total_tokens) | add),
            cost: (map(.cost_usd) | add | . * 100 | round / 100)
        } |
        "Today: \(.requests) requests, \(.tokens) tokens, $\(.cost)"
    ' -r 2>/dev/null
}

# Main command handler
case "${1:-today}" in
    -h|--help|help)
        show_help
        ;;
    -V|--version|version)
        echo "gt-usage $VERSION"
        ;;
    today)
        show_today
        ;;
    week)
        show_header "Gastown Usage Report - Last 7 Days"
        if [[ -f "$USAGE_LOG" ]]; then
            usage_report "week"
        else
            echo "No usage data found."
        fi
        ;;
    all)
        show_header "Gastown Usage Report - All Time"
        if [[ -f "$USAGE_LOG" ]]; then
            usage_report "all"
        else
            echo "No usage data found."
        fi
        ;;
    convoy)
        if [[ -z "$2" ]]; then
            echo "Error: convoy ID required"
            echo "Usage: gt-usage convoy <id>"
            exit 1
        fi
        show_convoy "$2"
        ;;
    rig)
        if [[ -z "$2" ]]; then
            echo "Error: rig name required"
            echo "Usage: gt-usage rig <name>"
            exit 1
        fi
        show_rig "$2"
        ;;
    task)
        if [[ -z "$2" ]]; then
            echo "Error: task ID required"
            echo "Usage: gt-usage task <id>"
            exit 1
        fi
        show_task "$2"
        ;;
    raw)
        if [[ -f "$USAGE_LOG" ]]; then
            cat "$USAGE_LOG"
        else
            echo "No usage data found."
        fi
        ;;
    summary)
        show_summary
        ;;
    *)
        show_today
        ;;
esac
