formula = "mol-gastown-e2e-bootstrap"
description = """
Gastown E2E Infrastructure Bootstrap — Validates a gastown K8s namespace has
all infrastructure components healthy. Runs the Phase 1 health test modules
(dolt, redis, daemon, nats, broker, controller, git-mirror) plus advanced
health checks (dolt-s3-sync, controller-failsafe, slack-bot-health).

If a step fails, it auto-files a bug linked to the E2E test epic.

Usage:
  gt formula run mol-gastown-e2e-bootstrap --var namespace=gastown-next
"""
version = 1
type = "workflow"

# ── Steps ────────────────────────────────────────────────────────────

[[steps]]
id = "verify-cluster"
title = "Verify K8s cluster access for {{namespace}}"
description = """
Confirm kubectl can reach the cluster and namespace {{namespace}} exists.

Action:
  kubectl cluster-info && kubectl get ns {{namespace}}

Verify:
  Exit code 0 means cluster is reachable and namespace exists.

OnFail:
  Cannot proceed without cluster access. Check kubeconfig and VPN.
"""

[[steps]]
id = "verify-dolt"
title = "Verify Dolt health in {{namespace}}"
description = """
Run the dolt-health test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-dolt-health.sh

Verify:
  All 7 tests pass (pod ready, SQL port, auth, beads DB, deploy config, s3-sync).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-dolt in {{namespace}}' --priority=1
"""
needs = ["verify-cluster"]

[[steps]]
id = "verify-redis"
title = "Verify Redis health in {{namespace}}"
description = """
Run the redis-health test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-redis-health.sh

Verify:
  All 5 tests pass (pod ready, service, PING/PONG, port-forward, INFO).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-redis in {{namespace}}' --priority=1
"""
needs = ["verify-cluster"]

[[steps]]
id = "verify-daemon"
title = "Verify BD daemon health in {{namespace}}"
description = """
Run the daemon-health test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-daemon-health.sh

Verify:
  All 8 tests pass (pod 2/2, containers, HTTP health, RPC port, status API, NATS, no panics).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-daemon in {{namespace}}' --priority=1
"""
needs = ["verify-dolt"]

[[steps]]
id = "verify-broker"
title = "Verify coop broker health in {{namespace}}"
description = """
Run the coop-broker-health test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-coop-broker-health.sh

Verify:
  All 8 tests pass (pod 2/2, containers, health 200, mux HTML, pods API, auth, registration, PVC).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-broker in {{namespace}}' --priority=1
"""
needs = ["verify-daemon"]

[[steps]]
id = "verify-controller"
title = "Verify agent controller health in {{namespace}}"
description = """
Run the controller-health test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-controller-health.sh

Verify:
  All 8 tests pass (deploy ready, pod running, SA, agent pods, no panics, image).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-controller in {{namespace}}' --priority=1
"""
needs = ["verify-daemon"]

[[steps]]
id = "verify-nats"
title = "Verify NATS event bus health in {{namespace}}"
description = """
Run the nats-health test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-nats-health.sh

Verify:
  All 10 tests pass (pod ready, ports, monitoring API, JetStream, consumers, daemon connected, bus status, handlers, throughput, error rate).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-nats in {{namespace}}' --priority=1
"""
needs = ["verify-daemon"]

[[steps]]
id = "verify-dolt-s3"
title = "Verify Dolt S3 sync health in {{namespace}}"
description = """
Run the dolt-s3-sync test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-dolt-s3-sync.sh

Verify:
  All 8 tests pass (s3-sync container, running, credentials, commit history, dolt status, S3 remote, activity, no crashes).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-dolt-s3 in {{namespace}}' --priority=1
"""
needs = ["verify-dolt"]

[[steps]]
id = "verify-controller-failsafe"
title = "Verify controller fail-safe in {{namespace}}"
description = """
Run the controller-failsafe test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-controller-failsafe.sh

Verify:
  All 7 tests pass (daemon reachable, reconcile interval, no orphans, fail-safe, managed labels, RBAC, health).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-controller-failsafe in {{namespace}}' --priority=1
"""
needs = ["verify-controller"]

[[steps]]
id = "verify-slack-bot"
title = "Verify Slack bot sidecar health in {{namespace}}"
description = """
Run the slack-bot-health test module against {{namespace}}.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-slack-bot-health.sh

Verify:
  All 8 tests pass (container exists, running, no crashes, NATS config, Slack credentials, NATS connection, subscription, no errors).

OnFail:
  File bug: bd create --type=bug --title='E2E FAIL: gastown-e2e-bootstrap:verify-slack-bot in {{namespace}}' --priority=1
"""
needs = ["verify-daemon"]

[[steps]]
id = "verify-git-mirror"
title = "Verify git mirror health in {{namespace}}"
description = """
Run the git-mirror-health test module against {{namespace}}.
Note: git-mirror is optional — tests skip gracefully if not deployed.

Action:
  E2E_NAMESPACE={{namespace}} ./tests/e2e/scripts/test-git-mirror-health.sh

Verify:
  Tests pass or skip (skip is OK if git-mirror not deployed).

OnFail:
  File bug only if git-mirror IS deployed but tests fail.
"""
needs = ["verify-cluster"]

[[steps]]
id = "infra-summary"
title = "Infrastructure health summary for {{namespace}}"
description = """
Produce the final infrastructure health report.

Action:
  Summarize: How many of the 10 infrastructure modules passed?
  Report any failures and their associated bug IDs.

Verify:
  All infrastructure modules report PASS (skips are acceptable for optional components).
"""
needs = ["verify-dolt", "verify-redis", "verify-daemon", "verify-nats", "verify-broker", "verify-controller", "verify-git-mirror", "verify-dolt-s3", "verify-controller-failsafe", "verify-slack-bot"]

# ── Variables ────────────────────────────────────────────────────────

[vars]

[vars.namespace]
description = "Target K8s namespace to validate"
required = true
