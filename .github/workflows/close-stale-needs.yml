name: Close stale needs-info / needs-repro issues

on:
  schedule:
    # Run daily at 09:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  close-needs-info:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Close stale needs-info issues (14 days)
        uses: actions/github-script@v7
        with:
          script: |
            const labels = ['status/needs-info', 'status/needs-repro'];
            const days = 14;

            const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

            for (const label of labels) {

              const issues = await github.paginate(github.rest.issues.listForRepo, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: label,
                per_page: 100,
              });

              for (const issue of issues) {
                // Skip PRs (the issues API returns both)
                if (issue.pull_request) continue;

                // Check if the label was applied after the last non-bot comment
                // by looking at whether the most recent comment is from the reporter
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  per_page: 5,
                  direction: 'desc',
                });

                // Find when the label was applied
                const events = await github.rest.issues.listEvents({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  per_page: 50,
                });

                const labelEvent = events.data
                  .filter(e => e.event === 'labeled' && e.label?.name === label)
                  .pop();

                if (!labelEvent) continue;

                const labeledAt = new Date(labelEvent.created_at);

                // Check for any comment from the issue author AFTER the label was applied
                const authorReplied = comments.data.some(c =>
                  c.user?.login === issue.user?.login &&
                  new Date(c.created_at) > labeledAt
                );

                if (authorReplied) continue;

                // Check if enough time has passed since the label was applied
                if (labeledAt > cutoff) continue;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `Closing â€” this was marked \`${label}\` 14 days ago with no response.\n\nIf this is still relevant, please reply with the requested details and we'll reopen.`,
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'not_planned',
                });

                console.log(`Closed #${issue.number} (${label}, labeled ${labeledAt.toISOString()})`);
              }
            }
