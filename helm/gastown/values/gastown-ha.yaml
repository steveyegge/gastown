# Gastown HA — Dolt HA cluster validation environment
# Namespace: gastown-ha
# Purpose: Validate Dolt HA (3-replica cluster with standby replication) before
#          migrating gastown-uat.
#
# NOTE: Currently deployed using the bd-daemon OCI chart directly (not the
#       gastown wrapper), because the gastown chart's OCI dep pull fails locally.
#
# Deploy:
#   helm pull oci://ghcr.io/groblegark/charts/bd-daemon --version 0.2.0 --untar --untardir /tmp/bd-daemon-deploy
#   helm upgrade --install gastown-ha /tmp/bd-daemon-deploy/bd-daemon/ \
#     -n gastown-ha --values helm/gastown/values/gastown-ha.yaml

# Daemon image — GitLab registry (GHCR ghcr.io/steveyegge/beads returns 403)
image:
  repository: registry.gitlab.com/pihealth/corefics/fics-helm-chart/beads
  tag: "0.57.12-16e06ba6"
  pullPolicy: IfNotPresent

imagePullSecrets:
  - name: gitlab-registry

# Daemon
daemon:
  replicaCount: 1
  logLevel: info
  logJSON: true
  http:
    enabled: true
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi

# Dolt HA cluster — 3 replicas with standby replication
dolt:
  statefulSet:
    enabled: true
  database: beads
  image:
    repository: 909418727440.dkr.ecr.us-east-1.amazonaws.com/external/dolthub/dolt-sql-server
    tag: "1.81.6"
  config:
    port: 3306
    max_connections: 50
    read_timeout_millis: 28800000
    write_timeout_millis: 28800000
    log_level: info
  cluster:
    enabled: true
    replicas: 3
    remotesapiPort: 50051
    bootstrapEpoch: 1
    clusterctl:
      enabled: true
      image:
        repository: 909418727440.dkr.ecr.us-east-1.amazonaws.com/external/dolthub/doltclusterctl
        tag: latest
      schedule: "*/1 * * * *"
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi
  persistence:
    enabled: true
    storageClass: gp2
    accessMode: ReadWriteOnce
    size: 5Gi
    deleteClaim: true
  s3:
    enabled: true
    region: us-east-1
    bucket: pihealth-dolt-beads
    prefix: gastown-ha
    dynamoTable: pihealth-dolt-beads
    credentials:
      enabled: true
      secretName: dolt-s3-credentials
    sync:
      pullOnStartup: true
      pushOnShutdown: true
      schedule:
        enabled: true
        intervalMinutes: 30
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi
  livenessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  terminationGracePeriodSeconds: 60

# Redis (needed by daemon for wisp store)
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  image:
    registry: public.ecr.aws
    repository: bitnami/redis
    tag: "7.4.2"
  master:
    persistence:
      enabled: false

# Standalone NATS — event bus for daemon, slack-bot, and agent pods
nats:
  enabled: true
  auth:
    enabled: true
    token: ""  # Set via --set nats.auth.token=<daemon-token> at deploy time
  jetstream:
    enabled: true
    maxMemory: 256M
  replicaCount: 1
  resourceType: statefulset
  persistence:
    enabled: true
    storageClass: gp2
    size: 2Gi
  image:
    registry: public.ecr.aws
    repository: bitnami/nats
    tag: "2.10.24"
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Allow ECR images (bitnami subchart blocks non-Docker Hub by default)
global:
  security:
    allowInsecureImages: true

# External Secrets
externalSecrets:
  enabled: true
  secretStoreKind: ClusterSecretStore
  secretStoreName: aws-secretsmanager
  refreshInterval: "15m"
  daemonToken:
    remoteRef: shared-e2e-bd-daemon-token
  doltRootPassword:
    remoteRef: shared-e2e-dolt-root-password
    property: password
