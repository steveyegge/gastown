# Gastown E2E Test Values
# Purpose: Ephemeral namespace for automated E2E test runs
#
# This file enables all components needed for the full E2E suite.
# ExternalSecret remoteRefs are NOT included (sensitive) — pass via --set.
#
# Prerequisites:
#   - ClusterSecretStore "aws-secretsmanager" must exist
#   - ghcr.io pull access (gitlab-registry secret created by wrapper chart,
#     or pass --set imagePullSecrets[0].name=<secret> if installing standalone)
#
# Usage (via provision-namespace.sh):
#   ./tests/e2e/scripts/provision-namespace.sh \
#     --set bd-daemon.externalSecrets.doltRootPassword.remoteRef=shared-e2e-dolt-root-password \
#     --set bd-daemon.externalSecrets.daemonToken.remoteRef=shared-e2e-bd-daemon-token \
#     --set bd-daemon.externalSecrets.doltS3Credentials.remoteRef=shared-e2e-dolt-s3-credentials \
#     --set bd-daemon.externalSecrets.slackBotCredentials.remoteRef=gastown-uat/slack-bot-credentials
#
# Usage (direct helm):
#   helm upgrade --install $NS ./helm/gastown/ \
#     -n $NS --create-namespace \
#     --values helm/gastown/values.yaml \
#     --values helm/gastown/values-e2e.yaml \
#     --set bd-daemon.externalSecrets.doltRootPassword.remoteRef=shared-e2e-dolt-root-password \
#     --set bd-daemon.externalSecrets.daemonToken.remoteRef=shared-e2e-bd-daemon-token \
#     --set bd-daemon.externalSecrets.doltS3Credentials.remoteRef=shared-e2e-dolt-s3-credentials \
#     --set bd-daemon.externalSecrets.slackBotCredentials.remoteRef=gastown-uat/slack-bot-credentials \
#     --timeout 600s --wait

# Image pull secrets for private ghcr.io images
imagePullSecrets:
  - name: gitlab-registry
  - name: docker-hub-registry

# BD Daemon subchart
bd-daemon:
  # Daemon image — pin to known-good tag (not latest, which may lack amd64)
  image:
    repository: ghcr.io/groblegark/beads
    tag: "0.57.17"
    pullPolicy: Always

  imagePullSecrets:
    - name: gitlab-registry
    - name: docker-hub-registry

  # Dolt — use ECR mirror to avoid Docker Hub rate limits
  dolt:
    image:
      repository: 909418727440.dkr.ecr.us-east-1.amazonaws.com/external/dolthub/dolt-sql-server
      tag: "1.81.6"
    nodeSelector:
      kubernetes.io/arch: amd64
    persistence:
      storageClass: "gp2"
      size: 5Gi
    s3:
      enabled: true
      bucket: "fics-gastown-dolt"
      region: "us-east-1"
      prefix: "e2e/"
      sync:
        pullOnStartup: false   # Fresh DB for E2E
        pushOnShutdown: false  # Don't pollute S3 with test data
        schedule:
          enabled: true
          intervalMinutes: 60
      credentials:
        enabled: true
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

  # Daemon
  daemon:
    replicaCount: 1
    priorityClassName: ""  # E2E doesn't need priority
    http:
      enabled: true
    nodeSelector:
      kubernetes.io/arch: amd64
    affinity: {}  # Override default per-mr anti-affinity for E2E
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

  # Redis — use ECR mirror to avoid Docker Hub rate limits
  redis:
    enabled: true
    image:
      registry: 909418727440.dkr.ecr.us-east-1.amazonaws.com
      repository: external/bitnami/redis
      tag: "latest"
    master:
      nodeSelector:
        kubernetes.io/arch: amd64
      persistence:
        storageClass: "gp2"
        size: 1Gi
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

  # NATS — enabled (event bus), uses public ECR
  nats:
    enabled: true
    image:
      registry: public.ecr.aws
      repository: docker/library/nats
      tag: "2.10-alpine"
    jetstream:
      maxMemory: 128M
    persistence:
      storageClass: "gp2"
      size: 1Gi
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

  # External Secrets — enabled, remoteRefs passed via --set
  externalSecrets:
    enabled: true
    secretStoreKind: ClusterSecretStore
    secretStoreName: "aws-secretsmanager"
    doltS3Credentials:
      enabled: true
    slackBotCredentials:
      enabled: true

  # Slack bot — disabled for E2E (requires SLACK_CHANNEL in Dolt config table)
  # Enable once seed-config step populates deploy.slack_channel
  slackBot:
    enabled: false

# Agent Controller — enabled for agent pod lifecycle tests
agentController:
  enabled: true
  image:
    repository: ghcr.io/groblegark/gastown/agent-controller
    tag: "latest"
    pullPolicy: Always
  agentImage:
    repository: ghcr.io/groblegark/gastown/gastown-agent
    tag: "latest"
  coopBuiltin: true
  credentialsSecret: "claude-credentials"
  nodeSelector:
    kubernetes.io/arch: amd64

# Coop Broker — enabled for terminal mux and credential distribution
coopBroker:
  enabled: true
  image:
    repository: ghcr.io/groblegark/gastown/gastown-agent
    tag: "latest"
    pullPolicy: Always
  nodeSelector:
    kubernetes.io/arch: amd64
  persistence:
    enabled: true
    storageClass: "gp2"
    size: 100Mi
  mux:
    enabled: true
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 256Mi

# No git mirrors for E2E (optional component)
gitMirrors: {}

# Registry pull secrets — ExternalSecrets for docker.io and registry.gitlab.com
# docker-hub short name resolves directly; gitlab needs full name via --set:
#   --set registrySecrets.registries.gitlab-registry.remoteRef=<full-secret-name>
registrySecrets:
  enabled: true
  secretStoreName: "aws-secretsmanager"
  secretStoreKind: ClusterSecretStore
  registries:
    docker-hub-registry:
      enabled: true
      remoteRef: "shared-devops-docker.io-credentials"
      hosts:
        - "docker.io"
        - "https://index.docker.io/v1/"
    gitlab-registry:
      enabled: true
      remoteRef: ""  # pass via --set (contains autogenerated suffix)
      hosts:
        - "registry.gitlab.com"

# Global
global:
  security:
    allowInsecureImages: true  # Required for ECR images
