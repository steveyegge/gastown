apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "agent-pod.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "agent-pod.labels" . | nindent 4 }}
    gastown.io/role: {{ .Values.agent.role }}
    gastown.io/rig: {{ .Values.agent.rig }}
spec:
  replicas: {{ .Values.agent.replicaCount }}
  {{- if .Values.agent.persistence.enabled }}
  strategy:
    type: Recreate
  {{- end }}
  selector:
    matchLabels:
      {{- include "agent-pod.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "agent-pod.selectorLabels" . | nindent 8 }}
        gastown.io/role: {{ .Values.agent.role }}
        gastown.io/rig: {{ .Values.agent.rig }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "agent-pod.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.agent.podSecurityContext | nindent 8 }}
      terminationGracePeriodSeconds: {{ .Values.agent.terminationGracePeriodSeconds }}
      {{- if .Values.agent.credentialsSecret }}
      initContainers:
        - name: copy-credentials
          image: busybox:1.36
          command: ["sh", "-c"]
          args:
            - |
              cp /tmp/claude-credentials/credentials.json /claude-home/.credentials.json
              chmod 600 /claude-home/.credentials.json
          volumeMounts:
            - name: claude-creds
              mountPath: /tmp/claude-credentials
              readOnly: true
            - name: claude-home
              mountPath: /claude-home
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
      {{- end }}
      containers:
        - name: agent
          image: "{{ .Values.agent.image.repository }}:{{ .Values.agent.image.tag }}"
          imagePullPolicy: {{ .Values.agent.image.pullPolicy }}
          {{- if .Values.agent.credentialsSecret }}
          command: ["sh", "-c"]
          args:
            - |
              printf '{"hasCompletedOnboarding":true,"lastOnboardingVersion":"2.1.37","preferredTheme":"dark"}\n' > "$HOME/.claude.json"
              exec coop --agent=claude --port 8080 --health-port {{ .Values.agent.coop.healthPort }} --cols 200 --rows 50 -- claude --dangerously-skip-permissions
          {{- end }}
          securityContext:
            {{- toYaml .Values.agent.securityContext | nindent 12 }}
          env:
            # Agent identity
            - name: GT_ROLE
              value: {{ .Values.agent.role | quote }}
            - name: GT_RIG
              value: {{ .Values.agent.rig | quote }}
            # Screen configuration
            - name: SCREENRC_SCROLLBACK
              value: {{ .Values.agent.screen.scrollback | quote }}
            # BD daemon connection
            {{- if .Values.bdDaemon.host }}
            - name: BD_DAEMON_HOST
              value: {{ .Values.bdDaemon.host | quote }}
            - name: BD_DAEMON_PORT
              value: {{ .Values.bdDaemon.port | quote }}
            {{- end }}
            # Anthropic API key from ExternalSecret
            {{- if and .Values.externalSecrets.enabled .Values.externalSecrets.anthropicApiKey.remoteRef }}
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "agent-pod.apiKeySecretName" . }}
                  key: api-key
            {{- end }}
            # Git credentials from ExternalSecret
            {{- if and .Values.externalSecrets.enabled .Values.externalSecrets.gitCredentials.enabled .Values.externalSecrets.gitCredentials.remoteRef }}
            - name: GIT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ include "agent-pod.gitCredentialsSecretName" . }}
                  key: username
            - name: GIT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ include "agent-pod.gitCredentialsSecretName" . }}
                  key: token
            {{- end }}
            - name: HOME
              value: "/home/agent"
            # Session persistence: coop + claude state on PVC
            - name: XDG_STATE_HOME
              value: "/home/agent/gt/.state"
            - name: GT_SESSION_RESUME
              value: {{ ternary "1" "0" (and .Values.agent.persistence.enabled (default true .Values.agent.sessionResume.enabled)) | quote }}
            {{- with .Values.agent.extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          volumeMounts:
            - name: config
              mountPath: /etc/agent-pod
              readOnly: true
            - name: workspace
              mountPath: /home/agent/gt
            - name: tmp
              mountPath: /tmp
            {{- if .Values.agent.credentialsSecret }}
            - name: claude-creds
              mountPath: /tmp/claude-credentials
              readOnly: true
            - name: claude-home
              mountPath: /home/agent/.claude
            {{- end }}
          {{- if .Values.agent.startupProbe.enabled }}
          startupProbe:
            {{- if .Values.agent.startupProbe.httpGet }}
            httpGet:
              path: {{ .Values.agent.startupProbe.httpGet.path }}
              port: {{ .Values.agent.startupProbe.httpGet.port | default .Values.agent.coop.healthPort }}
            {{- else }}
            exec:
              command: ["test", "-f", "/tmp/health/alive"]
            {{- end }}
            initialDelaySeconds: {{ .Values.agent.startupProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.agent.startupProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.agent.startupProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.agent.startupProbe.failureThreshold }}
          {{- end }}
          {{- if .Values.agent.livenessProbe.enabled }}
          livenessProbe:
            {{- if .Values.agent.livenessProbe.httpGet }}
            httpGet:
              path: {{ .Values.agent.livenessProbe.httpGet.path }}
              port: {{ .Values.agent.livenessProbe.httpGet.port | default .Values.agent.coop.healthPort }}
            {{- else }}
            exec:
              command: ["test", "-f", "/tmp/health/alive"]
            {{- end }}
            initialDelaySeconds: {{ .Values.agent.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.agent.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.agent.livenessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.agent.livenessProbe.failureThreshold }}
          {{- end }}
          {{- if .Values.agent.readinessProbe.enabled }}
          readinessProbe:
            {{- if .Values.agent.readinessProbe.httpGet }}
            httpGet:
              path: {{ .Values.agent.readinessProbe.httpGet.path }}
              port: {{ .Values.agent.readinessProbe.httpGet.port | default .Values.agent.coop.healthPort }}
            {{- else }}
            exec:
              command: ["test", "-f", "/tmp/health/alive"]
            {{- end }}
            initialDelaySeconds: {{ .Values.agent.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.agent.readinessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.agent.readinessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.agent.readinessProbe.failureThreshold }}
          {{- end }}
          resources:
            {{- toYaml .Values.agent.resources | nindent 12 }}
      volumes:
        - name: config
          configMap:
            name: {{ include "agent-pod.fullname" . }}-config
        {{- if .Values.agent.persistence.enabled }}
        - name: workspace
          persistentVolumeClaim:
            claimName: {{ include "agent-pod.fullname" . }}-workspace
        {{- else }}
        - name: workspace
          emptyDir: {}
        {{- end }}
        - name: tmp
          emptyDir: {}
        {{- if .Values.agent.credentialsSecret }}
        - name: claude-creds
          secret:
            secretName: {{ .Values.agent.credentialsSecret }}
        - name: claude-home
          emptyDir: {}
        {{- end }}
      {{- with .Values.agent.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.agent.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.agent.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
