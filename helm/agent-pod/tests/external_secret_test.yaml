suite: ExternalSecret tests
templates:
  - templates/external-secret.yaml
tests:
  - it: does not render when externalSecrets disabled
    set:
      externalSecrets.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: does not render API key secret when remoteRef empty
    asserts:
      - hasDocuments:
          count: 0

  - it: renders API key ExternalSecret when configured
    set:
      externalSecrets.enabled: true
      externalSecrets.anthropicApiKey.remoteRef: "gastown/anthropic-api-key"
      externalSecrets.anthropicApiKey.property: "ANTHROPIC_API_KEY"
    asserts:
      - isKind:
          of: ExternalSecret
        documentIndex: 0
      - equal:
          path: spec.secretStoreRef.kind
          value: ClusterSecretStore
        documentIndex: 0
      - equal:
          path: spec.secretStoreRef.name
          value: "aws-secretsmanager"
        documentIndex: 0
      - equal:
          path: spec.refreshInterval
          value: "15m"
        documentIndex: 0
      - equal:
          path: spec.data[0].remoteRef.key
          value: "gastown/anthropic-api-key"
        documentIndex: 0
      - equal:
          path: spec.data[0].remoteRef.property
          value: "ANTHROPIC_API_KEY"
        documentIndex: 0

  - it: renders git credentials ExternalSecret when configured
    set:
      externalSecrets.enabled: true
      externalSecrets.anthropicApiKey.remoteRef: "gastown/anthropic-api-key"
      externalSecrets.gitCredentials.enabled: true
      externalSecrets.gitCredentials.remoteRef: "gastown/git-credentials"
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ExternalSecret
        documentIndex: 1
      - equal:
          path: spec.data[0].remoteRef.property
          value: "username"
        documentIndex: 1
      - equal:
          path: spec.data[1].remoteRef.property
          value: "token"
        documentIndex: 1

  - it: does not render git credentials when disabled
    set:
      externalSecrets.enabled: true
      externalSecrets.anthropicApiKey.remoteRef: "gastown/api-key"
      externalSecrets.gitCredentials.enabled: false
    asserts:
      - hasDocuments:
          count: 1

  - it: renders with gastown-test values
    values:
      - ../values/gastown-test.yaml
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ExternalSecret
        documentIndex: 0
      - isKind:
          of: ExternalSecret
        documentIndex: 1

  - it: uses correct target secret names
    set:
      externalSecrets.enabled: true
      externalSecrets.anthropicApiKey.remoteRef: "gastown/api-key"
    asserts:
      - equal:
          path: spec.target.name
          value: RELEASE-NAME-agent-pod-api-key
        documentIndex: 0
      - equal:
          path: spec.target.creationPolicy
          value: Owner
        documentIndex: 0
